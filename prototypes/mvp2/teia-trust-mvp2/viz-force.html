<!DOCTYPE html>
<html>
<head>
    <title>Teia Trust Graph MVP2 (Force-Graph)</title>
    <script src="https://unpkg.com/d3"></script>
    <script src="https://unpkg.com/force-graph"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: monospace; margin: 0; overflow: hidden; }
        #controls { height: 60px; padding: 10px 20px; background: #1e293b; border-bottom: 1px solid #334155; display: flex; gap: 10px; align-items: center; }
        #legend { position: absolute; bottom: 20px; left: 20px; background: rgba(30, 41, 59, 0.9); padding: 15px; border-radius: 8px; border: 1px solid #334155; z-index: 5; font-size: 0.8em; line-height: 1.6em; }
        #graph-container { width: 100vw; height: calc(100vh - 80px); background: #0f172a; position: relative; min-height: 400px; }
        input { background: #334155; border: 1px solid #475569; color: white; padding: 10px; min-width: 350px; border-radius: 4px; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold;}
        button:hover { background: #1d4ed8; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        
        /* Modal Styles */
        #modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: #1e293b; margin: 15% auto; padding: 20px; border: 1px solid #334155; width: 400px; border-radius: 8px; position: relative; }
        .modal-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .modal-body div { margin-bottom: 15px; }
        .modal-body label { color: #94a3b8; display: block; font-size: 0.8em; margin-bottom: 4px; }
        .close { position: absolute; right: 20px; top: 15px; cursor: pointer; color: #94a3b8; }
        .btn-copy { background: #475569; font-size: 0.7em; margin-left: 5px; padding: 4px 8px; color: white; border: none; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>

<div id="controls">
    <label>Center:</label>
    <input type="text" id="centerNode" placeholder="tz... or id" value="">
    <button onclick="drawGraph()">Visualize Trust</button>
</div>

<div id="graph-container"></div>

<div id="legend">
    <div class="legend-item"><div class="dot" style="background: #ffffff"></div> <span>You (Center)</span></div>
    <div class="legend-item"><div class="dot" style="background: #22c55e"></div> <span>Trusted (Direct/Personalized)</span></div>
    <div class="legend-item"><div class="dot" style="background: #eab308"></div> <span>Known (Global Rank)</span></div>
    <div class="legend-item"><div class="dot" style="background: #475569"></div> <span>Unknown / Low Signal</span></div>
    <div style="margin-top:8px; color: #94a3b8; font-size: 0.9em; border-top: 1px solid #334155; padding-top: 8px;">
        Sizes based on Global PageRank<br>Labels show Artist Tags
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-header">Profile Info</div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
    let graph;

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = originalText, 1000);
        });
    }

    async function drawGraph() {
        const centerInput = document.getElementById('centerNode').value.trim();
        if(!centerInput) return alert("Please enter an address or ID");

        try {
            const res = await fetch(`http://127.0.0.1:8000/graph/${centerInput}`);
            const rawData = await res.json();
            
            if (!res.ok) {
                throw new Error(rawData.detail || "API Error");
            }

            if (!rawData.nodes || rawData.nodes.length === 0) {
                throw new Error("No graph data found for this address.");
            }
            
            // Map status & roles to colors (The Signal System)
            const nodes = rawData.nodes.map(n => {
                let color = '#475569'; // default low signal (grayish)
                
                if (n.status === 'GREEN') color = '#22c55e';  // vibrant green
                if (n.status === 'YELLOW') color = '#eab308'; // gold
                if (n.status === 'CENTER') color = '#ffffff'; // white center
                
                // Role-based stroke or pulse? Let's keep color for status, but role in stroke
                return {
                    ...n,
                    id: String(n.id),
                    color: color
                }
            });

            const nodeIds = new Set(nodes.map(n => n.id));
            const validLinks = rawData.edges
                .filter(e => nodeIds.has(String(e.from)) && nodeIds.has(String(e.to)))
                .map(e => ({
                    source: String(e.from),
                    target: String(e.to),
                    value: e.value
                }));

            const gData = {
                nodes: nodes,
                links: validLinks
            };

            const elem = document.getElementById('graph-container');
            if (graph) {
                graph.pauseAnimation();
                elem.innerHTML = '';
            }

            graph = ForceGraph()(elem)
                .width(elem.clientWidth)
                .height(elem.clientHeight)
                .graphData(gData)
                .nodeId('id')
                .nodeVal(n => Math.sqrt(n.score || 1) * 0.5 + 2) 
                .nodeLabel(n => `
                    <b>${n.name || n.address}</b><br>
                    ${n.tags.length > 0 ? 'Tags: ' + n.tags.join(', ') + '<br>' : ''}
                    Role: ${n.role}<br>
                    Global Score: ${n.score?.toFixed(2)}<br>
                    Subjective Score: ${n.subjective_score?.toFixed(2)}%
                `)
                .nodeColor(n => n.color)
                .linkWidth(l => Math.log1p(l.value || 1))
                .linkColor(l => {
                    // Highlight paths from the center
                    if (l.source.id === rawData.nodes.find(n => n.group === 'center')?.id) return 'rgba(234, 179, 8, 0.4)';
                    return 'rgba(148, 163, 184, 0.15)';
                })
                .linkDirectionalArrowLength(l => l.source.id === rawData.nodes.find(n => n.group === 'center')?.id ? 4 : 2)
                .linkDirectionalArrowRelPos(1)
                .onNodeClick(node => {
                    const body = document.getElementById('modalBody');
                    body.innerHTML = `
                        <div><label>Name</label><span>${node.name || 'Anonymous'}</span><button class="btn-copy" onclick="copyText('${node.name || ''}')">Copy</button></div>
                        <div><label>Address</label><span style="font-size:0.8em">${node.address}</span><button class="btn-copy" onclick="copyText('${node.address}')">Copy</button></div>
                        <div><label>Market Role</label><span style="text-transform: capitalize; font-weight: bold;">${node.role.replace('_', ' ')}</span></div>
                        ${node.tags.length > 0 ? `<div><label>Artist Tags</label><span style="color: #94a3b8">${node.tags.join(', ')}</span></div>` : ''}
                        <div><label>Global Trust</label><span>Rank #${node.rank || 'N/A'} (Score: ${(node.score || 0).toFixed(2)})</span></div>
                        <div><label>Subjective Trust</label><span style="color: ${node.color}">${node.subjective_score.toFixed(2)}% Match</span></div>
                    `;
                    document.getElementById('modal').style.display = 'block';
                })
                .nodeCanvasObject((node, ctx, globalScale) => {
                    const label = node.name || node.address.substring(0, 6);
                    const fontSize = 14/globalScale;
                    ctx.font = `${fontSize}px monospace`;
                    
                    // Node radius - scaled down to prevent overlap
                    const r = Math.sqrt(node.score || 1) * 0.8 + 2;
                    
                    // Node Circle
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, r, 0, 2 * Math.PI, false);
                    ctx.fillStyle = node.color;
                    ctx.fill();
                    
                    // Selection/Role Indicator
                    if (node.group === 'center' || node.role.includes('og')) {
                        ctx.strokeStyle = '#ffffff';
                        ctx.setLineDash(node.role.includes('og') ? [2, 2] : []); // Dash for OGs
                        ctx.lineWidth = 1/globalScale;
                        ctx.stroke();
                        ctx.setLineDash([]); // reset
                    }

                    // Text
                    if (globalScale > 2.5) { 
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = 'rgba(248, 250, 252, 0.8)';
                        ctx.fillText(label, node.x, node.y + r + fontSize);
                        
                        // Small sub-text for tags
                        if (node.tags && node.tags.length > 0 && globalScale > 4) {
                            ctx.font = `${fontSize * 0.7}px monospace`;
                            ctx.fillStyle = 'rgba(148, 163, 184, 0.6)';
                            ctx.fillText(node.tags[0], node.x, node.y + r + fontSize * 2);
                        }
                    }
                });

            // Physics Tuning - Stiffer for more stable clusters
            graph.d3Force('charge').strength(-150);
            graph.d3Force('link').distance(l => 60 / Math.log1p(l.value || 1)); 
            graph.d3Force('center', d3.forceCenter(elem.clientWidth / 2, elem.clientHeight / 2));
            graph.d3Force('center').strength(0.1);

            // Zoom to fit after a short delay to allow initial layout
            setTimeout(() => {
                graph.zoomToFit(400, 50);
            }, 500);
            
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }
</script>
</body>
</html>
